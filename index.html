<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>تقرير العمليات - الطوارئ</title>
  <link href="./style.css" rel="stylesheet" />
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700&display=swap" rel="stylesheet">
  <style>
    :root{ --accent:#27ae60; --muted:#9b9b9b; --bg:#0b0b0b; --card:#1d1c1c; }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:'Cairo', system-ui, Arial, sans-serif;
      background:var(--bg);
      color:#eee;
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
      padding:18px;
      direction: rtl; /* force RTL */
    }

    .bg-mark{
      position:fixed;
      inset:0;
      width:100%; height:100%;
      background: linear-gradient(rgba(11,11,11,0.62), rgba(11,11,11,0.62)), url("./1.png") center/cover no-repeat;
      pointer-events:none;
      filter:blur(1.8px);
      transform: scale(1.02);
      opacity:0.95;
      z-index:-1;
      background-blend-mode:multiply;
    }

    .top-nav{padding:12px 18px;}
    .top-nav nav { display:flex; gap:8px; align-items:center; justify-content:flex-start; flex-wrap:wrap; }
    .btn-pill {
      display:inline-flex; align-items:center; justify-content:center; gap:8px; padding:6px 14px;
      height:34px; line-height:1; font-size:14px; border-radius:18px; font-weight:700; white-space:nowrap;
    }
    .btn-pill.outline { background:transparent; color:var(--accent); border:1px solid var(--accent); }
    .btn-pill.filled { background:var(--accent); color:#fff; border:1px solid var(--accent); }

    .card{
      max-width:1100px;
      margin:0 auto;
      background:linear-gradient(#1a1a1a,#212121);
      border-radius:12px;
      padding:18px;
      box-shadow:0 8px 30px rgba(0,0,0,0.6);
    }

    .title{ text-align:center; color:var(--accent); margin:0 0 6px; font-size:26px; letter-spacing:1px; }
    .small-note{ color:var(--muted); font-size:13px; margin-bottom:8px; text-align:right; }

    .section { margin-bottom:18px; border-top:1px dashed rgba(255,255,255,0.03); padding-top:12px; }
    .section h3 {
      margin: 10px 0 6px;
      font-size:16px;
      color:var(--accent);
    }

    .row { display:flex; gap:8px; align-items:center; margin-bottom:10px; }
    .row label { min-width:160px; font-size:14px; color:#ddd; text-align:right; }
    .row .input { flex:1; margin-bottom:0; padding:8px; border-radius:6px; border:1px solid rgba(255,255,255,0.04); background:#222; color:#ddd }

    .add-btn { background:transparent; color:var(--accent); border:1px dashed rgba(39,174,96,0.35); padding:6px 10px; border-radius:8px; cursor:pointer; }
    .controls { display:flex; gap:8px; margin-top:10px; }
    .report-output { width:100%; min-height:220px; resize:vertical; padding:12px; background:#222; color:#ddd; border-radius:8px; border:1px solid rgba(255,255,255,0.03); white-space:pre-wrap; direction:rtl; }

    .del-btn { background:transparent; border:1px solid rgba(255,255,255,0.06); color:#ff6b6b; padding:6px 8px; border-radius:8px; cursor:pointer; font-weight:700; }
    .edit-btn { background:transparent; border:1px dashed rgba(255,255,255,0.06); color:#ffd36b; padding:6px 8px; border-radius:8px; cursor:pointer; font-weight:700; }

    .role.duplicate { border-color:#e74c3c !important; color:#ffb3b3 !important; background:rgba(231,76,60,0.04); }
    .row label.duplicate-label { color:#ff6b6b !important; }
    #dupWarning { color:#ff6b6b; display:none; margin-top:8px; font-size:13px; }

    .note-item{ display:flex; gap:8px; align-items:center; justify-content:space-between; padding:6px 8px; border-radius:6px; }
    .note-text{ color:#ddd; flex:1; padding-right:8px; }
    .note-actions{ display:flex; gap:6px; align-items:center; margin-left:8px; }

    .spacer { height:10px; }

    @media (max-width:980px){
      .card{width:92%; padding:16px;}
      .title{font-size:22px}
      .row label{min-width:120px}
    }
    @media (max-width:480px){
      .card{width:92%}
      .title{font-size:20px}
      .row label{min-width:100px}
    }
  </style>
</head>
<body>
  <div class="bg-mark" aria-hidden="true"></div>

  <div class="top-nav">
    <nav>
      <div class="btn-pill outline" aria-hidden="true">تقرير العمليات - الطوارئ</div>
      <a class="btn-pill filled" href="https://boletofsf.odoo.com/" target="_blank" rel="noopener noreferrer">العودة إلى الموقع</a>
    </nav>
  </div>

  <section class="card">
    <h1 class="title">تقرير العـــمـــلــيــات في الطوارئ</h1>
    <p class="small-note">املأ الحقول ثم اضغط "انشاء التقرير"</p>

    <form id="reportForm" onsubmit="return false;">
      <div class="section">
        <div class="row">
          <label>وقت استلام الشفت</label>
          <input id="shiftTimeDisplay" class="input" value="6 صباحا" readonly />
        </div>

        <div class="row">
          <label>العمليات (منشن)</label>
          <input id="operations" class="input" placeholder="@" />
        </div>

        <div class="row">
          <label>نائب العمليات (منشن)</label>
          <input id="opsDeputy" class="input" placeholder="@" />
        </div>
      </div>

      <div class="section">
        <h3>القيادة العامة</h3>
        <div class="row"><label>قائد قوات الطوارئ</label><input class="input role" data-role="قائد قوات الطوارئ" value="H-000" /></div>
        <div class="row"><label>مساعد قائد قوات الطوارئ</label><input class="input role" data-role="مساعد قائد قوات الطوارئ" value="H-000" /></div>
      </div>

      <div class="section" id="leadershipSection">
        <h3>القيادة (قابل للإضافة)</h3>
        <div id="leadershipList">
          <div class="row"><label>قيادة 1</label><input class="input role" data-role="قيادة 1" value="H-000" /></div>
          <div class="row"><label>قيادة 2</label><input class="input role" data-role="قيادة 2" value="H-000" /></div>
        </div>
        <button type="button" class="add-btn" data-target="leadershipList">＋ إضافة قيادة</button>

        <div style="margin-top:10px;">
          <div class="row">
            <label>ضابط خفر</label>
            <input id="dhInput" class="input role" data-role="ضابط خفر" value="H-000" />
          </div>
        </div>
      </div>

      <div class="section" id="radaSection">
        <h3>ردع (قابل للإضافة)</h3>
        <div id="radaList">
          <div class="row"><label>ردع 1</label><input class="input role" data-role="ردع 1" value="H-000"/></div>
          <div class="row"><label>ردع 2</label><input class="input role" data-role="ردع 2" value="H-000"/></div>
        </div>
        <button type="button" class="add-btn" data-target="radaList">＋ إضافة ردع</button>
      </div>

      <div class="section" id="radSection">
        <h3>رعد (قابل للإضافة)</h3>
        <div id="radList">
          <div class="row"><label>رعد 1</label><input class="input role" data-role="رعد 1" value="H-000"/></div>
          <div class="row"><label>رعد 2</label><input class="input role" data-role="رعد 2" value="H-000"/></div>
          <div class="row"><label>رعد 3</label><input class="input role" data-role="رعد 3" value="H-000"/></div>
        </div>
        <button type="button" class="add-btn" data-target="radList">＋ إضافة رعد</button>
      </div>

      <div class="section" id="regionsSection">
        <h3>الوحدات</h3>

        <!-- region add buttons + specific-name buttons -->
        <div class="row" style="align-items:center;">
          <label>أضف وحدة</label>
          <div style="display:flex;gap:8px;flex:1;flex-wrap:wrap;">
            <button type="button" class="add-btn" data-region="شمال" id="addNorthBtn">＋ شمال</button>
            <button type="button" class="add-btn" data-region="جنوب" id="addSouthBtn">＋ جنوب</button>
            <button type="button" class="add-btn" data-region="شرق" id="addEastBtn">＋ شرق</button>
            <button type="button" class="add-btn" data-region="غرب" id="addWestBtn">＋ غرب</button>

            <!-- شين / جيم / قاف / غين -->
            <button type="button" class="add-btn" data-addname="شين" id="addSheenBtn">＋ شين</button>
            <button type="button" class="add-btn" data-addname="جيم" id="addJeemBtn">＋ جيم</button>
            <button type="button" class="add-btn" data-addname="قاف" id="addQafBtn">＋ قاف</button>
            <button type="button" class="add-btn" data-addname="غين" id="addGhaynBtn">＋ غين</button>
          </div>
        </div>

        <div id="coastalList">
          <!-- شمال -->
          <div class="row"><label>شمال 1</label><input class="input role" data-role="شمال 1" value="H-000"/></div>
          <div class="row"><label>رمح 1</label><input class="input role" data-role="رمح 1" value="H-000"/></div>
          <div class="row"><label>شين 1</label><input class="input role" data-role="شين 1" value="H-000"/></div>
          <div class="row"><label>شين 2</label><input class="input role" data-role="شين 2" value="H-000"/></div>
          <div class="row"><label>شين 3</label><input class="input role" data-role="شين 3" value="H-000"/></div>

          <!-- spacer between شمال and جنوب -->
          <div class="row spacer"></div>

          <!-- جنوب -->
          <div class="row"><label>جنوب 1</label><input class="input role" data-role="جنوب 1" value="H-000"/></div>
          <div class="row"><label>رمح 2</label><input class="input role" data-role="رمح 2" value="H-000"/></div>
          <div class="row"><label>جيم 1</label><input class="input role" data-role="جيم 1" value="H-000"/></div>
          <div class="row"><label>جيم 2</label><input class="input role" data-role="جيم 2" value="H-000"/></div>
          <div class="row"><label>جيم 3</label><input class="input role" data-role="جيم 3" value="H-000"/></div>

          <!-- spacer between جنوب and شرق -->
          <div class="row spacer"></div>

          <!-- شرق -->
          <div class="row"><label>شرق 1</label><input class="input role" data-role="شرق 1" value="H-000"/></div>
          <div class="row"><label>رمح 3</label><input class="input role" data-role="رمح 3" value="H-000"/></div>
          <div class="row"><label>قاف 1</label><input class="input role" data-role="قاف 1" value="H-000"/></div>
          <div class="row"><label>قاف 2</label><input class="input role" data-role="قاف 2" value="H-000"/></div>
          <div class="row"><label>قاف 3</label><input class="input role" data-role="قاف 3" value="H-000"/></div>

          <!-- spacer between شرق and غرب -->
          <div class="row spacer"></div>

          <!-- غرب -->
          <div class="row"><label>غرب 1</label><input class="input role" data-role="غرب 1" value="H-000"/></div>
          <div class="row"><label>رمح 4</label><input class="input role" data-role="رمح 4" value="H-000"/></div>
          <div class="row"><label>غين 1</label><input class="input role" data-role="غين 1" value="H-000"/></div>
          <div class="row"><label>غين 2</label><input class="input role" data-role="غين 2" value="H-000"/></div>
          <div class="row"><label>غين 3</label><input class="input role" data-role="غين 3" value="H-000"/></div>

        </div>
      </div>

      <div style="margin-top:12px;">
        <div class="row"><label>شرطة عسكرية</label><input class="input role" data-role="شرطة عسكرية" value="H-000"/></div>
      </div>

      <div class="section" id="criminalSection">
        <h3>البحث الجنائي</h3>
        <div id="criminalList">
          <div class="row"><label>قائد فرقة البحث الجنائي</label><input class="input role" data-role="قائد فرقة البحث الجنائي" value="H-000"/></div>
          <div class="row"><label>نائب الفرقة</label><input class="input role" data-role="نائب الفرقة" value="H-000"/></div>
          <div class="row"><label>جنائي 1</label><input class="input role" data-role="جنائي 1" value="H-000"/></div>
          <div class="row"><label>جنائي 2</label><input class="input role" data-role="جنائي 2" value="H-000"/></div>
        </div>
      </div>

      <div class="section" id="specialForcesSection">
        <h3>القوات الخاصة</h3>
        <div id="specialForcesList">
          <div class="row"><label>قائد فرقة القوات الخاصة</label><input class="input role" data-role="قائد فرقة القوات الخاصة" value="H-000"/></div>
          <div class="row"><label>نائب الفرقة</label><input class="input role" data-role="نائب الفرقة" value="H-000"/></div>
          <div class="row"><label>حزم 1</label><input class="input role" data-role="حزم 1" value="H-000"/></div>
          <div class="row"><label>رمح 1</label><input class="input role" data-role="رمح 1" value="H-000"/></div>
        </div>
      </div>

      <div class="section" id="securitySection">
        <h3>الأمن والحماية</h3>
        <div id="securityList">
          <div class="row"><label>حماية 1</label><input class="input role" data-role="حماية 1" value="H-000"/></div>
          <div class="row"><label>حماية 2</label><input class="input role" data-role="حماية 2" value="H-000"/></div>
          <div class="row"><label>حماية 3</label><input class="input role" data-role="حماية 3" value="H-000"/></div>
          <div class="row"><label>حماية 4</label><input class="input role" data-role="حماية 4" value="H-000"/></div>
        </div>
      </div>

      <div class="section" id="prisonsSection">
        <div style="margin-top:6px;">
          <div class="row"><label>عين 1</label><input class="input role" data-role="عين 1" value="H-000"/></div>
          <div class="row"><label>سجن 1</label><input class="input role" data-role="سجن 1" value="H-000"/></div>
          <div class="row"><label>سجن 2</label><input class="input role" data-role="سجن 2" value="H-000"/></div>
        </div>
      </div>

      <div class="section" id="notesSection">
        <h3>ملاحظات مضافة</h3>
        <div class="row" style="align-items:flex-start;">
          <label>ملاحظات مضافة</label>
          <div id="notesList" style="flex:1;display:flex;flex-direction:column;gap:6px"></div>
        </div>
      </div>

      <div id="dupWarning">هناك أكواد مكررة — تم تمييزها باللون الأحمر</div>

      <div class="controls">
        <button type="button" id="buildReport" class="btn primary" style="flex:1">انشاء التقرير</button>
        <button type="button" id="copyReport" class="btn secondary" style="width:150px;display:none">نسخ التقرير</button>
      </div>

      <div style="margin-top:12px;">
        <textarea id="reportOutput" class="report-output" placeholder="سيظهر التقرير هنا بعد الضغط"></textarea>
      </div>
    </form>
  </section>

  <script>
    // الآن سلوك الإضافة: كل زر منطقة يضيف صفا بنفس اسم الزر (شمال -> "شمال N")
    // ويتم إدراج الصف الجديد تحت آخر صف يحمل نفس الاسم (أي تحت "شمال 1" يأتي "شمال 2").
    const EXCLUDED_LABELS = ['قائد امن المنشأت','نائب قائد امن المنشأت','وقت استلام الشفت'];
    const EXCLUDE_PREFIXES = ['قيادة'];
    const EXCLUDED_INPUT_IDS = ['operations','opsDeputy','shiftTimeDisplay','noteCode','noteCount','noteType'];

    function attachRoleListener(input) {
      if (!input) return;
      if (input.dataset.listenerAttached==='1') return;
      input.addEventListener('input', checkDuplicates);
      input.dataset.listenerAttached='1';
    }

    function createRow(labelText,dataRole,targetId){
      const row = document.createElement('div'); row.className='row';
      const label = document.createElement('label'); label.textContent = labelText;
      const input = document.createElement('input'); input.className='input role'; input.setAttribute('data-role',dataRole); input.value='H-000';
      const del = document.createElement('button'); del.type='button'; del.className='del-btn'; del.textContent='حذف';
      del.addEventListener('click', ()=> { row.remove(); checkDuplicates(); });
      row.appendChild(label); row.appendChild(input); row.appendChild(del);
      attachRoleListener(input);
      return row;
    }

    // Safe binding for add buttons
    document.querySelectorAll('.add-btn').forEach(btn=>{
      if (btn.dataset.boundAdd === '1') return;
      btn.addEventListener('click', ()=>{
        const target = btn.getAttribute('data-target');
        const region = btn.getAttribute('data-region');
        const name = btn.getAttribute('data-addname');
        if (target) {
          const list = document.getElementById(target);
          if (!list) return console.warn('add-btn: target not found ->', target);
          const existing = list.querySelectorAll('.row').length;
          const index = existing + 1;
          const firstLabel = list.querySelector('.row label');
          const base = firstLabel ? firstLabel.textContent.split(' ')[0] || 'عنصر' : 'عنصر';
          const labelText = base + ' ' + index;
          const newRow = createRow(labelText, labelText, target);
          list.appendChild(newRow);
          bindStaticRowDeleteButtons();
          checkDuplicates();
        } else if (region) {
          addRegionRow(region);
        } else if (name) {
          addNamedRow(name);
        }
      });
      btn.dataset.boundAdd = '1';
    });

    // addRegionRow: insert under the last row that starts with the same region name.
    function addRegionRow(regionName) {
      const list = document.getElementById('coastalList');
      if (!list) return;
      const allRows = Array.from(list.querySelectorAll('.row'));

      // regex to find existing rows for this region (e.g., "شمال 1")
      const escRegion = regionName.replace(/[.*+?^${}()|[\]\\]/g,'\\$&');
      const regexSelf = new RegExp('^' + escRegion + '\\s+(\\d+)$');

      // find existing indices and same-name rows
      const indicesSelf = [];
      const sameRows = [];
      allRows.forEach(r=>{
        if (r.classList && r.classList.contains('spacer')) return;
        const labelNode = r.querySelector('label');
        if (!labelNode) return;
        const txt = (labelNode.textContent || '').trim();
        const m = txt.match(regexSelf);
        if (m) {
          indicesSelf.push(parseInt(m[1], 10));
          sameRows.push(r);
        }
      });

      // compute smallest missing index
      const idxSet = new Set(indicesSelf);
      let idxSelf = 1;
      while (idxSet.has(idxSelf)) idxSelf++;

      const labelText = regionName + ' ' + idxSelf;
      const newRow = createRow(labelText, labelText, 'coastalList');

      // If there are existing rows with same region, insert after the last one
      if (sameRows.length) {
        sameRows[sameRows.length - 1].after(newRow);
        bindStaticRowDeleteButtons();
        checkDuplicates();
        return;
      }

      // Fallback: try to insert near the logical group position (before the first spacer of that region order)
      const order = ['شمال','جنوب','شرق','غرب'];
      const idxOrder = order.indexOf(regionName);
      let inserted = false;
      for (let k = idxOrder + 1; k < order.length; k++) {
        const nextRegion = order[k];
        const nextRow = allRows.find(r=>{
          if (r.classList && r.classList.contains('spacer')) return false;
          const ln = r.querySelector('label'); if (!ln) return false;
          return (ln.textContent||'').trim().startsWith(nextRegion + ' ');
        });
        if (nextRow) {
          nextRow.before(newRow);
          inserted = true;
          break;
        }
      }
      if (!inserted) {
        // append to end
        list.appendChild(newRow);
      }

      bindStaticRowDeleteButtons();
      checkDuplicates();
    }

    // addNamedRow: behave as before (adds/name N). If same-name rows exist inserts after last same-name.
    function addNamedRow(name) {
      const list = document.getElementById('coastalList');
      if (!list) return;
      const allRows = Array.from(list.querySelectorAll('.row'));
      const esc = name.replace(/[.*+?^${}()|[\]\\]/g,'\\$&');
      const regex = new RegExp('^' + esc + '\\s+(\\d+)$');

      const indices = [];
      const sameRows = [];
      allRows.forEach(r=>{
        if (r.classList && r.classList.contains('spacer')) return;
        const ln = r.querySelector('label'); if (!ln) return;
        const txt = (ln.textContent||'').trim();
        const m = txt.match(regex);
        if (m) { indices.push(parseInt(m[1],10)); sameRows.push(r); }
      });

      // smallest missing index
      const set = new Set(indices);
      let idx = 1;
      while (set.has(idx)) idx++;

      const labelText = name + ' ' + idx;
      const newRow = createRow(labelText, labelText, 'coastalList');

      if (sameRows.length) {
        sameRows[sameRows.length - 1].after(newRow);
        bindStaticRowDeleteButtons();
        checkDuplicates();
        return;
      }

      // fallback insert near logical region (previous behavior)
      const regionMap = { 'شين':'شمال', 'جيم':'جنوب', 'قاف':'شرق', 'غين':'غرب' };
      const targetRegion = regionMap[name] || '';
      if (targetRegion) {
        const regionRow = allRows.find(r=>{
          if (r.classList && r.classList.contains('spacer')) return false;
          const ln = r.querySelector('label'); if (!ln) return false;
          return (ln.textContent||'').trim().startsWith(targetRegion + ' ');
        });
        if (regionRow) regionRow.before(newRow);
        else list.appendChild(newRow);
      } else {
        const spacer = allRows.find(r=> r.classList && r.classList.contains('spacer'));
        if (spacer) list.insertBefore(newRow, spacer);
        else list.appendChild(newRow);
      }

      bindStaticRowDeleteButtons();
      checkDuplicates();
    }

    function bindStaticRowDeleteButtons(){
      document.querySelectorAll('.row > .del-btn').forEach(btn=>{
        if (btn.dataset.boundDelete==='1') return;
        btn.addEventListener('click', ()=> {
          const row = btn.closest('.row');
          if (row) row.remove();
          checkDuplicates();
        });
        btn.dataset.boundDelete='1';
      });
    }

    // duplicate check
    function checkDuplicates(){
      const inputs = Array.from(document.querySelectorAll('.role'));
      const map = new Map();
      inputs.forEach(inp=>{
        const row = inp.closest('.row');
        if (!row) return;
        if (row.dataset.hidden==='true' || getComputedStyle(row).display==='none') return;
        const v = (inp.value||'').trim().toUpperCase();
        if (!v || v==='H-000' || v.startsWith('@')) return;
        if (!map.has(v)) map.set(v,[]);
        map.get(v).push({inp,row});
      });

      document.querySelectorAll('.role').forEach(inp=>{
        inp.classList.remove('duplicate');
        const lbl = inp.parentElement && inp.parentElement.querySelector('label');
        if (lbl) lbl.classList.remove('duplicate-label');
      });
      document.getElementById('dupWarning').style.display='none';

      let dupFound=false;
      map.forEach(arr=>{
        if (arr.length>1) {
          dupFound=true;
          arr.forEach(obj=>{
            obj.inp.classList.add('duplicate');
            const lbl = obj.row.querySelector('label');
            if (lbl) lbl.classList.add('duplicate-label');
          });
        }
      });
      if (dupFound) document.getElementById('dupWarning').style.display='block';
    }

    // build report helpers & main buildReportText (unchanged)
    function appendFromContainer(containerId, out, addBlankAfter = false) {
      const container = document.getElementById(containerId);
      if (!container) return;
      const rows = container.querySelectorAll('.row');
      rows.forEach(row=>{
        if (row.classList && row.classList.contains('spacer')) { if (addBlankAfter) out.push(''); return; }
        if (row.dataset.hidden==='true' || getComputedStyle(row).display==='none') return;
        const roleName = (row.querySelector('label')||{}).textContent || '';
        const codeInput = row.querySelector('.role');
        let val = 'H-000';
        if (codeInput) val = (codeInput.value && codeInput.value.trim())? codeInput.value.trim() : 'H-000';
        if (roleName) out.push(roleName + ' : ' + val);
      });
      if (addBlankAfter) out.push('');
    }

    function appendCoastalWithGaps(out){
      const container = document.getElementById('coastalList'); if (!container) return;
      const rows = Array.from(container.querySelectorAll('.row'));
      rows.forEach(r => {
        if (r.dataset.hidden==='true' || getComputedStyle(r).display==='none') return;
        if (r.classList && r.classList.contains('spacer')) { out.push(''); return; }
        const roleName = (r.querySelector('label')||{}).textContent || '';
        const codeInput = r.querySelector('.role');
        let val='H-000';
        if (codeInput) val = (codeInput.value && codeInput.value.trim())? codeInput.value.trim() : 'H-000';
        if (roleName) out.push(roleName + ' : ' + val);
      });
    }

    function buildReportText(){
      checkDuplicates();
      const out=[];
      const shiftLabel='الطوارئ';
      const timeLabel='6 صباحا';

      out.push('تقرير العـــمـــلــيــات في ' + shiftLabel);
      out.push('');
      out.push('تم استلام عمليات ' + shiftLabel + ' في تمام الساعه ' + timeLabel);
      out.push('');

      const rawOps = (document.getElementById('operations').value||'').trim();
      const rawOpsDeputy = (document.getElementById('opsDeputy').value||'').trim();
      const operations = rawOps ? (rawOps.startsWith('@')?rawOps:('@'+rawOps)) : '';
      const opsDeputy = rawOpsDeputy ? (rawOpsDeputy.startsWith('@')?rawOpsDeputy:('@'+rawOpsDeputy)) : '';
      out.push('العمليات : ' + (operations || ''));
      out.push('نائب العمليات : ' + (opsDeputy || ''));
      out.push('');

      const leaderMain = document.querySelector('input[data-role="قائد قوات الطوارئ"]');
      if (leaderMain) out.push(leaderMain.getAttribute('data-role') + ' : ' + (leaderMain.value && leaderMain.value.trim() ? leaderMain.value.trim() : 'H-000'));
      const leaderAssist = document.querySelector('input[data-role="مساعد قائد قوات الطوارئ"]');
      if (leaderAssist) out.push(leaderAssist.getAttribute('data-role') + ' : ' + (leaderAssist.value && leaderAssist.value.trim() ? leaderAssist.value.trim() : 'H-000'));

      out.push('');
      appendFromContainer('leadershipList', out, false);
      out.push('');

      const dh = document.querySelector('input[data-role="ضابط خفر"]');
      if (dh) {
        let val = (dh.value && dh.value.trim())?dh.value.trim():'H-000';
        out.push(dh.getAttribute('data-role') + ' : ' + val);
      }
      out.push('');

      appendFromContainer('radaList', out, false);
      out.push('');
      appendFromContainer('radList', out, false);
      out.push('');

      appendCoastalWithGaps(out);
      out.push('');

      const police = document.querySelector('input[data-role="شرطة عسكرية"]');
      if (police) {
        let val = (police.value && police.value.trim())?police.value.trim():'H-000';
        out.push(police.getAttribute('data-role') + ' : ' + val);
        out.push('');
      }

      out.push('البحث الجنائي');
      out.push('');
      appendFromContainer('criminalList', out, false);
      out.push('');

      out.push('القوات الخاصة');
      out.push('');
      appendFromContainer('specialForcesList', out, false);
      out.push('');

      out.push('الأمن والحماية');
      out.push('');
      appendFromContainer('securityList', out, false);
      out.push('');

      appendFromContainer('prisonsSection', out, false);
      out.push('');

      const noteItems = Array.from(document.querySelectorAll('#notesList .note-item'));
      if (noteItems.length>0) {
        out.push('ملاحظات التقرير :');
        noteItems.forEach(it=>{
          const code = it.dataset.code||''; const count = it.dataset.count||''; const type = it.dataset.type||'';
          let parts=[]; if (code) parts.push(code+':'); if (count) parts.push(count); if (type) parts.push(type);
          const line = parts.join(' ');
          if (line) out.push(line);
        });
      }

      while (out.length && out[out.length-1]==='') out.pop();
      return out.join('\n');
    }

    // copy/report buttons
    const buildBtn = document.getElementById('buildReport');
    const copyBtn = document.getElementById('copyReport');
    const output = document.getElementById('reportOutput');
    buildBtn.addEventListener('click', ()=> {
      const text = buildReportText();
      output.value = text;
      copyBtn.style.display='inline-block';
      output.focus(); output.select();
    });
    copyBtn.addEventListener('click', async ()=>{
      if (!output.value) return alert('لا يوجد تقرير لنسخه');
      try {
        await navigator.clipboard.writeText(output.value);
        copyBtn.textContent='تم النسخ ✓';
        setTimeout(()=>copyBtn.textContent='نسخ التقرير',1500);
      } catch(e) { alert('فشل النسخ — جرّب يدوياً'); }
    });

    // initial binding
    document.querySelectorAll('.row').forEach(r=>{
      const roleInp = r.querySelector('.role'); if (roleInp) attachRoleListener(roleInp);
    });
    bindStaticRowDeleteButtons();
    checkDuplicates();

    // observe dynamic changes to attach listeners to newly added rows
    const observer = new MutationObserver(muts=>{
      muts.forEach(m=>{
        m.addedNodes.forEach(node=>{
          if (!(node instanceof HTMLElement)) return;
          node.querySelectorAll && node.querySelectorAll('.role').forEach(attachRoleListener);
          bindStaticRowDeleteButtons();
        });
      });
    });
    observer.observe(document.body,{childList:true,subtree:true});
  </script>
</body>
</html>
